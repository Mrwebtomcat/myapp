<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
	    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	    <meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="email=no" />
		<meta name="format-detection" content="address=no" />
		<meta name="format-detection" content="date=no" />
	    <title>收货地址</title>

	   	<link rel="stylesheet" type="text/css" href="css/Allcss.css"/> 
	   	<link rel="stylesheet" type="text/css" href="css/chang_msg.css"/>
	   	<script type="text/javascript"src="js/common.js"></script>
	   	<script type="text/javascript" src="js/jquery.min.js"></script>
	   		   	<script src="js/zepto.js" type="text/javascript" ></script>

    <link rel="stylesheet" type="text/css" href="css/jquery-weui.min.css" />

	   		<script src="js/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-weui/1.0.1/js/jquery-weui.min.js"></script>
<script type="text/javascript" src="js/city-picker.min.js"></script>
	   	<script type="text/javascript" src="js/jquery.cookie.js"></script>

	</head>
	

	<body>
		
		
		
		
		<form action="" id="changUser">
			<div id="changUser_head">
				<p class="title">
					收货人信息
				</p>
				<div id="userBasic">
					<label for="">
						<p>姓名</p>
						<input type="text" placeholder="请输入真实姓名"id="username"/>
					</label>
					<label for="">
						<p>手机</p>
						<input type="text" placeholder="请输入您的手机号码"id="userphone"/>
					</label>
				</div>
			</div>
			
			
			
			
			
			
			
			<div id="changUser_body">
				<p class="title">
					配送信息
				</p>
				<div id="userAdd">
					<div id="userAddOne">
						<p>
							收货时间：
						</p>
						<div id="dateDiv">
						
							<select class="date" id="shouhuodeta">
						
								<!--<option value="1">每周一 </option>-->
								<option value="2">每周二 </option>
								<!--<option value="3">每周三 </option>-->
								<!--<option value="4">每周四 </option>-->
								<!--<option value="5">每周五 </option>-->
								<option value="6">每周六 </option>
								<!--<option value="7">每周日 </option>-->
							</select>
							
							<div class="peisongimg"><img src="img/arrow_right_gray.png" /></div>
						</div>
					</div>
					<div id="userAddTwo">
						<p>
							所在地区：
						</p>
						<div id="clickEle">
							
							
							<!--<input type="text" id='city-picker'  placeholder='请选择省市区县'/>-->
							
							<input type='text' id='city-picker' placeholder='请选择省市区县' />
														
					<style>
						#city-picker{
							    width: 53%;
						}
					</style>
							<div class="peisongimg"><img src="img/arrow_right_gray.png"style="width:100%;height:100%" /></div>
						</div>
					</div>
					<div id="userAddThree">
						<p>
							详细地址：
						</p>
						<input id="userAddress" type="text" />	
					</div>
				</div>
			</div>
			<div id="seveadd">
				保存地址
			</div>
		</form>
		

<script>
    $("#city-picker").cityPicker({
        title: "选择省市区/县",
        onChange: function (picker, values, displayValues) {
//          console.log(values, displayValues);
        }
    });
    
</script>
		
		
		

		<script>
			
			var url=GetQueryString("url");
			var id=GetQueryString("id");
			var UpdatAddId=GetQueryString("UpdatAddId");	
			var token=$.cookie("token");			
			var orderId=GetQueryString("orderId");
			var chack=GetQueryString("chack");
			
			$(function(){
				
				if(orderId){
					
					
					$.ajax({
						type:"get",
						url:server+'/api/Order/GetOne/'+orderId+'?token='+token,
						dataType:"json",
						success:function(data){
							$("#username").val(data.Result.DeliveryName);
							$("#userphone").val(data.Result.DeliveryPhone);
							$("#shouhuodeta").find("option").text()==data.Result.CanDelivery;
//							$("#city-picker").val(data.Result.Province+data.Result.City+data.Result.Area);
							
//							var displayValuess=[data.Result.Province,data.Result.City,data.Result.Area].slice(",").join(" ");
//							console.log(displayValues)
//							 $("#city-picker").cityPicker({
//							        title: "选择省市区/县",
//							        onChange: function (picker, values, displayValues) {
//							         console.log(values, displayValues);
////							         displayValuess=displayValues;
//							        }
//							    })

							var orderAddon=[], qu='',add='';
							orderAddon=data.Result.DeliveryAddress.split("");
							orderAddons=orderAddon.indexOf("区")+1;
							qu=orderAddon.splice(0,orderAddons).join("");
							
							add=orderAddon.join("");
							 $("#city-picker").val(qu);
							$("#userAddress").val(add);
							
							if(chack=="zhuan"){
								$("#shouhuodeta").attr("class","date input-no");
							}else{
								$("#username").attr("class","input-no");
								$("#userAddress").attr("class","input-no");
								 $("#city-picker").attr("class","input-no");
								 $("#userphone").attr("class","input-no");
							}
							
							

						}
					});
				}
				
				
			
				
				if(UpdatAddId){
					$.ajax({
						type:"get",
						url:server+'/api/Address/GetOne/'+UpdatAddId+'?token='+token,
						dataType:"json",
						success:function(data){
							$("#username").val(data.Result.AddressName);
							$("#userphone").val(data.Result.Phone);
							$("#shouhuodeta").find("option:selected").text(data.Result.Village);
							
							 $("#city-picker").val(data.Result.Province+" "+data.Result.City+" "+data.Result.Area);
							
//							var displayValuess=[data.Result.Province,data.Result.City,data.Result.Area].slice(",").join(" ");
//							console.log(displayValues)
//							 $("#city-picker").cityPicker({
//							        title: "选择省市区/县",
//							        onChange: function (picker, values, displayValues) {
//							         console.log(values, displayValues);
//							         displayValuess=displayValues;
//							        }
//							    })
//							 $("#city-picker").val(displayValuess);
							
							
							$("#userAddress").val(data.Result.Address);

						}
					});
				}
				
				
			})

			
			$("#seveadd").bind("click",function(){
				if($("#username").val()==""){
						alert("请填写姓名");
						return;
					}
					if($("#userphone").val()==""){
						alert("请填写手机号");
						return;
					}
					if($("#uesrdizhi").find("option:selected").text()=="请选择省市区 "){
						alert("请选择地区");
						return;
					}
					if( $("#userAddress").val()==""){
						alert("请填写详细地址");
						return;
					}

				if(!UpdatAddId){
//					
					$.ajax({
						type:"post",
						url:server+'/api/Address/Post?token='+token,
						dataType:"json",
						data: { AddressName:$("#username").val(), Phone:$("#userphone").val(), Province: $("#city-picker").val().split(" ")[0], City:$("#city-picker").val().split(" ")[1], Area:$("#city-picker").val().split(" ")[2],Village:$("#shouhuodeta").find("option:selected").text(),Address: $("#userAddress").val()},
						success:function(data){
							if(url=="submitOrder.html"){
								location.href=url+'?url=change_msg.html&id='+id;
								}
							if(url=="address.html"){
								location.href=url+'?url=submitOrder.html&id='+id;
								}
							}
						});
					}
				if(UpdatAddId){
						$.ajax({
							type:"post",
							url:server+'/api/Address/Update?token='+token,
							dataType:"json",
							data: {Id:UpdatAddId,AddressName:$("#username").val(), Phone: $("#userphone").val(), Province: $("#city-picker").val().split(" ")[0], City:$("#city-picker").val().split(" ")[1], Area:$("#city-picker").val().split(" ")[2],Village:$("#shouhuodeta").find("option:selected").text(),Address: $("#userAddress").val()},
							success:function(data){
								if(id=="null"){
									location.href=url;
								}else{
										location.href=url+'?url=submitOrder.html&id='+id;
								}
							
							}
						});
					}
					if(orderId){
						$.ajax({
							type:"post",
							url:server+'/api/Order/Update?token='+token,
							dataType:"json",
							data: {Id:orderId,DeliveryName:$("#username").val(), DeliveryPhone: $("#userphone").val(), 
							
							
							DeliveryAddress: $("#city-picker").val().split(" ")+$("#userAddress").val(), Village:$("#shouhuodeta").find("option:selected").text()},
							success:function(data){
								
								location.href=url;
							}
						});
						
					}
					
					
					
					})
				
			
		</script>
		
	
		
		
		
	</body>
</html>
